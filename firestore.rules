rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /** 共通ユーティリティ */
    function signedIn() { return request.auth != null; }
    function isString(x) { return x is string && x.size() <= 5000; }

    /** メンバーのロール（存在しなければ null）*/
    function roleOf(orgId) {
      return request.auth != null
        ? get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role
        : null;
    }
    function hasAnyRole(orgId, roles) {
      return signedIn() && roles.hasAny([roleOf(orgId)]);
    }

    // ==========================================================
    // News
    // ==========================================================
    match /organizations/{orgId}/news/{newsId} {
      allow read: if signedIn();
      allow create: if signedIn()
        && request.resource.data.orgId == orgId
        && isString(request.resource.data.title)
        && request.resource.data.createdAt is timestamp;
      allow update, delete: if false;
    }

    // ==========================================================
    // organizations/{orgId} 以下
    // ==========================================================
    match /organizations/{orgId} {

      // org 本体
      allow read: if signedIn();
      allow update: if hasAnyRole(orgId, ['owner','admin']);
      allow create, delete: if false;

      // 施設
      match /facilities/{facilityId} {
        allow read: if signedIn();
        allow write: if hasAnyRole(orgId, ['owner','admin']);
      }

      // メンバー
      match /members/{uid} {
        allow read: if signedIn() && (request.auth.uid == uid || hasAnyRole(orgId, ['owner','admin']));
        allow write: if hasAnyRole(orgId, ['owner','admin']);
      }

      // ==========================================================
      // 公開求人 publicJobs
      // ==========================================================
      match /publicJobs/{pubId} {
        allow read: if true;

        // create（publishJob）
        allow create: if hasAnyRole(orgId, ['owner','admin','editor'])
          && request.resource.data.orgId == orgId
          && isString(request.resource.data.title)
          && isString(request.resource.data.wage)
          && isString(request.resource.data.description)
          && isString(request.resource.data.storagePath)
          // 施設情報
          && isString(request.resource.data.facilityName)
          && isString(request.resource.data.facilityAddress)
          && isString(request.resource.data.facilityType)
          // 求人情報
          && isString(request.resource.data.employmentType)
          && isString(request.resource.data.workingHours)
          && isString(request.resource.data.requirements)
          && isString(request.resource.data.benefits)
          // サムネ（null か string）
          && (request.resource.data.thumbnailPath is string
              || request.resource.data.thumbnailPath == null)
          && (request.resource.data.thumbnailURL is string
              || request.resource.data.thumbnailURL == null)
          // timestamp
          && request.resource.data.publishedAt is timestamp
          && isString(request.resource.data.publishedBy);

        // update（updatePublishedJob）
        allow update: if hasAnyRole(orgId, ['owner','admin','editor'])
          && request.resource.data.orgId == orgId;

        allow delete: if false;
      }

      // ==========================================================
      // リコログ
      // ==========================================================
      match /licologPosts/{postId} {
        allow create: if signedIn()
          && request.resource.data.orgId == orgId
          && request.resource.data.status == 'pending';

        allow read: if signedIn() || resource.data.status == 'approved';

        allow update: if signedIn()
          && resource.data.authorUid == request.auth.uid
          && resource.data.orgId == orgId
          && request.resource.data.orgId == orgId
          && request.resource.data.authorUid == resource.data.authorUid
          && request.resource.data.facilityId == resource.data.facilityId
          && request.resource.data.createdAt == resource.data.createdAt
          && resource.data.status == 'pending'
          && request.resource.data.status == 'pending';

        allow update: if hasAnyRole(orgId, ['owner','admin','editor'])
          && resource.data.orgId == orgId
          && request.resource.data.orgId == orgId
          && resource.data.status == 'pending'
          && request.resource.data.status in ['approved','hidden'];

        allow update: if hasAnyRole(orgId, ['owner','admin'])
          && resource.data.orgId == orgId
          && request.resource.data.orgId == orgId
          && resource.data.status == 'approved'
          && request.resource.data.status == 'pending'
          && request.resource.data.authorUid == resource.data.authorUid
          && request.resource.data.facilityId == resource.data.facilityId
          && request.resource.data.createdAt == resource.data.createdAt;

        allow delete: if false;
      }

      // 承認イベント
      match /events/{eventId} {
        allow read: if hasAnyRole(orgId, ['owner','admin','editor']);
        allow create: if hasAnyRole(orgId, ['owner','admin','editor'])
          && request.resource.data.orgId == orgId;
        allow update, delete: if false;
      }

      // ==========================================================
      // applications（応募）
      // ==========================================================
      match /applications/{appId} {
        allow create: if request.resource.data.orgId == orgId
          && isString(request.resource.data.jobPubId)
          && isString(request.resource.data.name)
          && isString(request.resource.data.contact)
          && request.resource.data.createdAt is timestamp;

        allow read: if hasAnyRole(orgId, ['owner','admin']);

        allow update: if hasAnyRole(orgId, ['owner','admin'])
          && request.resource.data.orgId == orgId
          && request.resource.data.name == resource.data.name
          && request.resource.data.contact == resource.data.contact
          && request.resource.data.jobPubId == resource.data.jobPubId
          && request.resource.data.createdAt == resource.data.createdAt
          && request.resource.data.status in ['pending','review','done'];

        allow delete: if false;
      }

      // metrics（読み取り専用）
      match /metrics/{document=**} {
        allow read: if hasAnyRole(orgId, ['owner','admin','editor','staff','viewer']);
        allow write: if false;
      }

      // jobViews（PV 記録）
      match /jobViews/{docId} {
        allow create: if true;
        allow read: if request.auth != null;
      }
    }

    // 別パスに二重定義してたので統一
    match /organizations/{orgId}/jobViews/{docId} {
      allow create: if true;
      allow read: if request.auth != null;
    }
  }
}
