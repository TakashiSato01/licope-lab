rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // --- ルート直下の jobs（任意：古いテストやツール用） ---
    match /jobs/{jobId} {
      allow create, read: if signedIn();
      allow update, delete: if false;
    }

    // --- 組織配下 ---
    match /organizations/{orgId} {

      // 求人（下書き）
      match /jobs/{jobId} {
        // まずは認証済み & orgId 整合のみ許可（下書き作成）
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        // 一覧/詳細の参照（社内用なので認証必須）
        allow read: if signedIn();
        // 更新/削除は後で段階的に開ける
        allow update, delete: if false;
      }

      // ★ これを追加：組織配下の jobs
      match /jobs/{jobId} {
        // orgId フィールドの整合を必須にして作成を許可
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        // 読み取りは社内だけOK（必要に応じて絞ってください）
        allow read: if signedIn();
        allow update, delete: if false;
      }

      // リコログ
      match /licologPosts/{postId} {
        allow create: if signedIn()
          && request.resource.data.status == 'pending'
          && request.resource.data.orgId == orgId;

        allow read: if signedIn();

        allow update: if signedIn()
          && resource.data.orgId == orgId
          && request.resource.data.orgId == orgId
          && resource.data.status == 'pending'
          && request.resource.data.status == 'approved';

        allow delete: if false;
      }

      // 承認イベント（履歴）
      match /events/{eventId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        allow update, delete: if false;
      }
    }
  }
}