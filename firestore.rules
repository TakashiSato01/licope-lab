rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // --- ルート直下の jobs（任意：古いテストやツール用） ---
    match /jobs/{jobId} {
      allow create, read: if signedIn();
      allow update, delete: if false;
    }

    // --- 組織配下 ---
    match /organizations/{orgId} {

    // 公開済み求人のメタ（誰でも読める）
    match /publicJobs/{pubId} {
      // 公開は誰でも見られる
      allow read: if true;
      // 作成/更新はログイン済み & orgId一致
      allow create, update: if signedIn() && request.resource.data.orgId == orgId;
      allow delete: if false;
    }

      // 求人（下書き）
      match /jobs/{jobId} {
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        allow read: if signedIn();
        allow update, delete: if false;
      }

      // ★ これを追加：組織配下の jobs
      match /jobs/{jobId} {
        // orgId フィールドの整合を必須にして作成を許可
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        // 読み取りは社内だけOK（必要に応じて絞ってください）
        allow read: if signedIn();
        allow update, delete: if false;
      }

      // リコログ
      match /licologPosts/{postId} {
        allow create: if signedIn()
          && request.resource.data.status == 'pending'
          && request.resource.data.orgId == orgId;

        allow read: if signedIn();

        allow update: if signedIn()
          && resource.data.orgId == orgId
          && request.resource.data.orgId == orgId
          && resource.data.status == 'pending'
          && request.resource.data.status == 'approved';

        allow delete: if false;
      }

      // ★ 公開済み求人のメタ
      match /publicJobs/{pubId} {
        allow read: if true; // 公開読み取り
        allow create, update, delete: if signedIn() && request.resource.data.orgId == orgId;
      }

      // 承認イベント（履歴）
      match /events/{eventId} {
        allow read: if signedIn();
        allow create: if signedIn() && request.resource.data.orgId == orgId;
        allow update, delete: if false;
      }
    }
  }
}